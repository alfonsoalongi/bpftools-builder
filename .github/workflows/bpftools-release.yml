name: Build bpftools archive (arm64)

on:
  push:
    tags: [ 'v*' ]          # es. v1.6.0
  workflow_dispatch:        # avvio manuale se serve

jobs:
  build_bpftools:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    steps:
      ######################################################################
      # 0) Il tuo repo (può essere vuoto) – serve solo per avere .github/   #
      ######################################################################
      - uses: actions/checkout@v4

      ##############################################################
      # 1) Aggiungi 4 GB di swap per evitare OOM durante il link    #
      ##############################################################
      - name: Add 4 GB swap
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      ##############################################################
      # 2) Clona ExtendedAndroidTools in ./src (shallow)            #
      ##############################################################
      - name: Clone ExtendedAndroidTools
        run: git clone --depth 1 https://github.com/facebookexperimental/ExtendedAndroidTools.git src

      ##############################################################
      # 3) Installa le dipendenze host (script upstream)            #
      ##############################################################
      - name: Install dependencies
        run: sudo ./src/scripts/jammy-install-deps.sh

      ######################################################################
      # 3-bis) Tool extra per autoreconf di flex (autopoint / gettext)      #
      ######################################################################
      - name: Extra build tools
        run: sudo apt-get update && sudo apt-get install -y autopoint gettext

      ##############################################################
      # 4) Scarica l’NDK (di default r26b)                          #
      ##############################################################
      - name: Download NDK
        run: ./src/scripts/download-ndk.sh

      ########################################################################
      # 5) Build tool-chain HOST (llvm/clang/python) con 4 thread            #
      #    —> RAM 7-8 GB.  Poi cancelliamo build/host per spazio.            #
      ########################################################################
      - name: Build host tool-chain & cleanup
        working-directory: ./src
        run: |
          set -e
          make host-llvm host-clang host-python THREADS=4
          echo "Disk before cleanup:"; df -h .
          rm -rf build/host
          echo "Disk after cleanup:"; df -h .

      ########################################################################
      # 6) Build bpftools arm64 – keep-alive + trace + NDK dinamico          #
      ########################################################################
      - name: Build bpftools (arm64)
        working-directory: ./src
        run: |
          set -e
          set -x

          # keep-alive: stampa ogni 5 minuti
          ( while true; do
              echo "::notice ::⏳ $(date -u) — build alive"
              sleep 300
            done ) &
          KEEP=$!

          # full clone per bpftrace (cherry-pick)
          export GIT_DEPTH=0

          # trova la cartella NDK appena estratta
          NDK_DIR=$(ls -d ../android-ndk-*)
          echo "Using NDK_DIR=$NDK_DIR"

          # THREADS=4 per build più veloce
          make bpftools NDK_ARCH=arm64 NDK_PATH=$NDK_DIR THREADS=4

          kill $KEEP
          cp bpftools-arm64.tar.gz $GITHUB_WORKSPACE/

      ##############################################################
      # 7) Genera SHA256                                           #
      ##############################################################
      - name: SHA256
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum bpftools-arm64.tar.gz > SHA256SUMS

      ##############################################################
      # 8) Artifact temporaneo (debug)                             #
      ##############################################################
      - uses: actions/upload-artifact@v4
        with:
          name: bpftools-arm64.tar.gz
          path: bpftools-arm64.tar.gz

      ##############################################################
      # 9) Asset permanente in Release (solo sui tag v*)           #
      ##############################################################
      - name: Upload Release asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bpftools-arm64.tar.gz
            SHA256SUMS
          generate_release_notes: true
